version: '3'

services:

  arasaac:
    image: nginx
    hostname: newarasaac
    container_name: newarasaac
    volumes:
       - ./arasaac-conf/:/etc/nginx/conf.d:ro
       - ./arasaac-code/:/usr/share/nginx/html
    environment:
      LETSENCRYPT_HOST: "beta.arasaac.org"
      LETSENCRYPT_EMAIL: "juandacorreo@gmail.com"
      VIRTUAL_HOST: "beta.arasaac.org"
    networks:
      - nginxproxy_frontend
  webstatic:
    image: nginx
    hostname: webstatic
    container_name: webstatic
    volumes:
       - ./materials:/usr/share/nginx/html:ro
       - ./webstatic-conf/:/etc/nginx/conf.d:ro
    environment:
      LETSENCRYPT_HOST: "static.arasaac.org"
      LETSENCRYPT_EMAIL: "juandacorreo@gmail.com"
      VIRTUAL_HOST: "static.arasaac.org"
    networks:
      - nginxproxy_frontend

  api:
    hostname: api
    container_name: api
    build:
      context: ./api
      dockerfile: node-dockerfile.yml
    command: yarn start
    depends_on:
      - mongodb
    volumes:
    - ./api/app:/app
    - ./materials:/app/materials
    - /app/node_modules
    environment:
      LETSENCRYPT_HOST: "api.arasaac.org"
      LETSENCRYPT_EMAIL: "juandacorreo@gmail.com"
      VIRTUAL_HOST: "api.arasaac.org"
      NODE_ENV: "production"
    networks:
      - nginxproxy_frontend
      - backend
    ports:
      - "9229:9229"
  
  watcher:
    hostname: watcher
    container_name: watcher
    build:
      context: ./watcher
      dockerfile: node-dockerfile.yml
    command: yarn start
    volumes:
    - ./watcher/app:/app
    - ./materials:/app/materials
    - /app/node_modules

  mongodb:
    hostname: mongodb
    container_name: mongodb
    image: mongo
    volumes:
      - ./mongodb/dump:/docker-entrypoint-initdb.d
      - ./mongodb/dbdata:/data/db
    networks:
      - backend
    ports:
      - "27000:27017"

networks:
  nginxproxy_frontend:
    external: true
  backend:
    driver: bridge
